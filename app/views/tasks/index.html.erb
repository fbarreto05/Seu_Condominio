<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<% content_for :title, "Tasks" %>

<style>
  html, body {
    background-color: #d8d8d8ff;
      margin: 0;
      padding: 0;
      p
      {
        margin-bottom: 0px;
        border-radius: 5px;
      }
      div, label
      {
        border-radius: 5px;
      }
      img
      {
        border-radius: 5px;
      }
      input, select
      {
        border-radius: 5px;
      }
    }
  
  .accordion-button::after {
    display: none !important;
  }
  .accordion-button::before {
    flex-shrink: 0;
    width: 1.25rem;
    height: 1.25rem;
    margin-right: .5rem;
    content: "";
    background-image: var(--bs-accordion-btn-icon);
    transform: rotate(-90deg);
    background-repeat: no-repeat;
    background-size: 1.25rem;
    transition: transform .2s ease-in-out;
  }
  .accordion-button:not(.collapsed)::before {
    transform: rotate(0deg);
  }

  .hidden-comment {
  display: none;
  }
</style>

<div id="header" style="border-radius: 0px; background: linear-gradient(to top, #005f7a, #00CFFF); display: flex; background-color: #007AA2; justify-content: space-between; padding: 10px; align-items: center;">
  <div id="main_control" style="display: flex;">
    <a href="#"><%= image_tag "sidebar.png", alt: "sidebar", style: "height: 50px; width: 50px;" %></a>
    <a href="#"><%= image_tag "logo.png", alt: "logo",  style: "height: 50px; width: 100px;" %></a>
  </div>
  <div id="user_area">
    <div id="profile" style="display: flex; align-items: center; justify-content: right; gap: 5px;">
      <p style=" margin: 0px; font-size:small; color: white;">Rogerio</p>
      <p style=" margin: 0px; font-size:small; background: linear-gradient(to top, #c90000ff, #e40303ff);  background-color: #d30000ff; color: white;">Sair</p>
    </div>
    <div id="search_bar" style="display: flex; align-items: center; gap: 5px; margin-top: 10px;">
      <div id="search_bar_square" style="background-color: white; height: 19.5px; width: 19.5px;"></div>
      <p style="margin-top: 0px; font-size:small; margin-bottom: 0px; background-color: white">Bosque do Cerrado</p>
      <a href="#"><%= image_tag "down_arrow.png", alt: "arrow",  style: "vertical-align: baseline; height: 15px; width: 15px;"%></a>
    </div>
  </div>
</div>

<div id="register" style="display: flex; margin-top: 10px; justify-content: flex-end;">
  <div class="imagem-container" style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); background: linear-gradient(to top, #005f7a, #00CFFF); background-color: #007AA2; height: 30px; width: 30px; display: flex; justify-content: center; align-items: center; border-top-right-radius: 0px; border-bottom-right-radius: 0px;">
    <button type="button" style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); background: none; border: none; padding: 0px" data-bs-toggle="modal" data-bs-target="#newTaskModal">
      <%= image_tag "plus_sign.png", alt: "logo", style: "padding: 3px; height: 25px; width: 25px;" %>
    </button>
  </div>
  <p style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-right: 10px; background-color:white; padding: 3px; border-top-left-radius: 0px; border-bottom-left-radius: 0px;">Cadastrar Tarefa</p>
</div>

<div class="modal fade" id="newTaskModal">
  <div class="modal-dialog modal-dialog-centered" style="width: 95%">
    <div class="modal-content">
      <div class="modal-header" style="gap: 5px; background-color: #d8d8d8ff; display: flex; justify-content: flex-start;">
        <%= image_tag "down_chevron.png", alt: "down_chevron", style: "height: 15px; width: 25px;" %>
         <div style="border-left: 1px solid #666; height: 20px; margin: 0 8px;"></div>
        <h5 class="modal-title" id="newTaskModalLabel" style="color:#007AA2">Nova Tarefa</h5>
      </div>
      <div class="modal-body">
        <%= render 'form', task: Task.new %>
      </div>
    </div>
  </div>
</div>

<br>
<div style=" justify-content:center; display: flex;">
  <div class="accordion" id="tasksAccordion" style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); width: 95%;">
    <div id="tasks" style=" width: 100%;">
      <% @tasks.each do |task| %>
        <div class="accordion-item">
          <h2 class="accordion-header" style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); width: 100%; display: flex; background-color: #d8d8d8ff;"; id="heading<%= task.id %>">
            <button class="accordion-button collapsed" type="button" style="border: 1px solid black; background-color: #d8d8d8ff;"
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapse<%= task.id %>" 
                    aria-expanded="false" 
                    aria-controls="collapse<%= task.id %>">
              <%= task.name %>
            </button>
            <button type="button" style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); border-radius: 5px; background: none; border: none; border: 1px solid black; " data-bs-toggle="modal" data-bs-target="#editTaskModal_<%= task.id %>">
                <%= image_tag "edit.png", alt: "logo", style: "height: 25px; width: 25px; vertical-align: baseline;" %>
            </button>
          </h2>
          <div id="collapse<%= task.id %>" 
              class="accordion-collapse collapse" 
              aria-labelledby="heading<%= task.id %>" 
              data-bs-parent="#tasksAccordion">
            <div class="accordion-body" style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); width: 100%; padding-top: 1rem;padding-right: 0rem;padding-bottom: 1rem;padding-left: 0rem;">
              
              <div id="date" style="display: flex; justify-content: center;">
                <div>
                  <p style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); padding: 10px; display: block; color: #007AA2; text-align: center; background-color: #d8d8d8ff; border: 1px solid black;">Início</p>
                  <p style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); padding: 10px; display: block; color: #007AA2; text-align: center; background-color: #d8d8d8ff; border: 1px solid black;"><%= task.beginning %></p>
                </div>

                <div>
                  <p style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); padding: 10px; display: block; color: #007AA2; text-align: center; background-color: #d8d8d8ff; border: 1px solid black;">Conclusão</p>
                  <p style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); padding: 10px; display: block; color: #007AA2; text-align: center; background-color: #d8d8d8ff; border: 1px solid black;"><%= task.end %></p>
                </div>
              </div>
              <br>
              <div id="status" style="display: flex; justify-content: center; gap: 30px;">
                <div>
                  <div style="text-align: center;">
                    <p style="color: #007AA2;">Custo Estimado</p>
                    <p><%= task.estimated_cost %></p>
                  </div>
                </div>
                
                <div>
                  <div style="text-align: center;">
                    <p style="color: #007AA2;">Status</p>
                    <p><%= task.status %></p>
                  </div>
                </div>
              </div>

              <br>
              <div style="padding: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);  background-color: #d8d8d8ff; height: 50px; width: 100%; display: flex; gap: 10px; align-items: center;">
                <%= image_tag "commentary.png", alt: "logo", style: "height: 25px; width: 25px;" %>
                <p>Comentários</p>
              </div>
              <br>
              <div id="comments-container">
                <% commentaries = Commentary.where(task_id: task.id) %>
                <% commentaries.each_with_index do |commentary, index| %>
                  <div class="comment <%= 'hidden-comment' if index >= 2 %>">
                    <div style="box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); display: block; text-align: left; margin-bottom: 1rem;">
                      <div style="display:flex; align-items: flex-start; gap: 10px;">
                        
                        <div>
                          <%= image_tag "user.png", alt: "logo", style: "height: 75px; width: 75px;" %>
                        </div>

                        <div style="width: 100%;">
                          <div id="delete" style="display: flex; justify-content: space-between; align-items: center;">
                            <p style="color:#007AA2; margin: 0;"><%= commentary.name %></p>
                            <%= link_to commentary_path(commentary), class: "btn btn-secondary btn-sm", data: { turbo_method: :delete }, style: "display: flex; background: none; border: none; gap: 5px;" do %>
                              <div class="imagem-container" style="box-shadow: 0 4px 6px rgba(0,0,0,0.3); background-color: #d8d8d8ff; height: 30px; width: 30px; display: flex; justify-content: center; align-items: center;">
                                <%= image_tag "trash.png", alt: "delete", style: "height: 25px; width: 25px;" %>
                              </div>
                              
                            <% end %>
                          </div>

                          <p style="word-wrap: break-word; overflow-wrap: break-word; margin: 5px 0; width: 70%">
                            <%= commentary.text %>
                          </p>

                          <p style="color:#007AA2; font-size: small; margin: 0;">Comentado em: <%= commentary.date %></p>
                        </div>
                      </div>
                      <hr style="margin-top: 10px;"/>
                    </div>
                  </div>
                <% end %>

                <div style="display: flex; justify-content: center">
                  <% if commentaries.size > 2 %> 
                    <button id="show-more-comments" class="btn btn-primary" style="background: linear-gradient(to top, #38c700ff, #2ea300ff);  box-shadow: 0 4px 6px rgba(0,0,0,0.3); background-color: #33b400ff">
                      <div style="display: flex; justify-content: center; align-items: center">
                        Ver Mais Comentários
                        <div id="show-more-comments" class="imagem-container" style="background: linear-gradient(to top, #38c700ff, #2ea300ff);  background-color: #33b400ff; height: 38px; width: 38px; display: flex; justify-content: center; align-items: center;">
                            <%= image_tag "down_arrow.png", alt: "logo", style: "padding: 3px; height: 30px; width: 30px;" %>
                        </div>
                      </div>
                    </button>
                  <% end %>
                </div>
                <br><br>
                
                <% if commentaries.empty? %>
                  <p style="text-align: center">Sem comentários ainda!</p>
                <% end %>
              </div>
              <div style="padding: 10px;">
                <%= render 'commentaries/form', commentary: Commentary.new, task: task %>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade" id="editTaskModal_<%= task.id %>">
          <div class="modal-dialog modal-dialog-centered" style="width: 95%">
            <div class="modal-content">
              <div class="modal-header" style="gap: 5px; background-color: #d8d8d8ff; display: flex; justify-content: flex-start;">
                <%= image_tag "down_chevron.png", alt: "down_chevron", style: "height: 15px; width: 25px;" %>
                <h5 class="modal-title" id="newTaskModalLabel">Editar Tarefa</h5>
              </div>
              <div class="modal-body">
                <%= render 'form', task: task %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("show-more-comments");
  if (btn) {
    btn.addEventListener("click", () => {
      const hiddenComments = document.querySelectorAll("#comments-container .hidden-comment");
      hiddenComments.forEach(c => {
        c.classList.remove("hidden-comment");
        c.style.display = "block";
      });
      btn.style.display = "none";
    });
  }
});
</script>


  


